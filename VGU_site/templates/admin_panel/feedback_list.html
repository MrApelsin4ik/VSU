<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Список обратной связи — управление</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --accent:#2563eb; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:28px; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:radial-gradient(circle at top, #e0edff 0, #f3f4f6 60%);
      color:#111827;
    }
    .page{
      max-width:1100px; margin:0 auto; background:var(--card); border-radius:14px;
      padding:20px; box-shadow:0 18px 40px rgba(15,23,42,.12);
    }
    h1{margin:0 0 8px 0; font-size:22px}
    .top-actions{display:flex; gap:8px; align-items:center; margin-bottom:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;}
    .btn-primary{background:linear-gradient(135deg,var(--accent),#1d4ed8); color:#fff; border-color:transparent}
    .panel-actions{display:flex;gap:8px;align-items:center;margin-bottom:12px}

    .table-wrap{overflow-x:auto}
    table.feedback-table{width:100%;border-collapse:collapse;font-family:inherit; table-layout:fixed}
    thead th{background:#f7f7f8;padding:10px 12px;text-align:left;font-weight:700;border-bottom:1px solid #e5e5e5}
    tbody td{padding:10px 12px;border-bottom:1px solid #f0f0f0;vertical-align:middle}

    .id-cell{width:70px;font-weight:700}
    .subject{font-weight:600}
    .muted{color:var(--muted);font-size:0.95em}
    .desc-preview{margin-top:6px;color:#666;font-size:0.95em}

    .actions-row{display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .actions-cell{text-align:right;width:170px}

    .toggle-btn, .action-btn, .delete-btn{cursor:pointer;border:1px solid #d6d6d6;background:#fff;padding:6px 8px;border-radius:6px;font-size:0.95em}
    .delete-btn{color:#b33;border-color:#f2c6c6}

    /* детали скрыты/показаны через aria-hidden */
    tr.details-row[aria-hidden="true"]{display:none}
    tr.details-row[aria-hidden="false"]{display:table-row;background:#fff}

    .details-cell{padding:0;border-bottom:1px solid #eee}
    .details-inner{padding:12px}
    .details-content{display:flex;gap:24px;align-items:flex-start}
    .left-col{flex:1 1 60%}
    .right-col{flex:0 0 280px}

    /* миниатюры — жёсткое ограничение размеров */
    .images-grid{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .thumb-btn{padding:0;background:transparent;border:0;cursor:pointer}
    .thumb-btn:focus{outline:3px solid rgba(0,120,215,0.12); border-radius:6px}
    .thumb-btn img{display:block;width:48px;height:48px;max-width:48px;max-height:48px;object-fit:cover;border-radius:6px}

    /* модал */
    .image-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1200;padding:20px}
    .image-modal[aria-hidden="false"]{display:flex}
    .modal-img{max-width:90vw;max-height:80vh;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,.5)}
    .modal-close{position:absolute;top:18px;right:18px;z-index:1300;background:#fff;border-radius:8px;padding:6px 8px;border:0;cursor:pointer}

    /* мобильная адаптация */
    @media (max-width:900px){
      .details-content{flex-direction:column}
      .right-col{width:100%}
    }
  </style>
</head>
<body>
  <div class="page" role="main">
    <header style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
      <div>
        <h1>Админ-панель <span style="font-size:11px;background:rgba(37,99,235,.08);color:#1d4ed8;padding:3px 8px;border-radius:999px;margin-left:8px">Управление</span></h1>
        <p class="muted" style="margin:6px 0 0 0">Служебные страницы для управления контентом сайта.</p>
      </div>
      <div class="top-actions">
        <a class="btn" href="/">На сайт</a>
        <button class="btn" type="button" onclick="history.back()">← Назад</button>
      </div>
    </header>

    <div class="panel-actions">
      <button id="expand-all" class="action-btn" type="button">Раскрыть всё ▾</button>
      <button id="collapse-all" class="action-btn" type="button" style="display:none">Свернуть всё ▴</button>
    </div>

    <div class="table-wrap" role="region" aria-label="Список отзывов">
      <table class="feedback-table" aria-describedby="feedback-desc">
        <thead>
          <tr>
            <th style="width:70px">ID</th>
            <th>Тема</th>
            <th style="width:160px">Раздел</th>
            <th style="width:220px">Контакты</th>
            <th style="width:170px;text-align:right">Действия</th>
          </tr>
        </thead>
        <tbody>
          {# Пример: ниже используйте ваш Django loop. Я оставил шаблонные теги, чтобы можно было вставить прямо в проект #}
          {% for fb in feedbacks %}
            <tr class="summary-row" id="summary-{{ fb.id }}" data-fbid="{{ fb.id }}">
              <td class="id-cell">#{{ fb.id }}</td>
              <td>
                <div class="subject">{{ fb.subject }}</div>
                <div class="muted desc-preview">{{ fb.description|truncatechars:120 }}</div>
              </td>
              <td class="section">{{ fb.section }}</td>
              <td class="contacts">
                {% if fb.contact_email %}<div>Email: {{ fb.contact_email }}</div>{% endif %}
                {% if fb.contact_phone %}<div>Тел.: {{ fb.contact_phone }}</div>{% endif %}
              </td>
              <td class="actions-cell">
                <div class="actions-row">
                  <button class="toggle-btn" aria-expanded="false" aria-controls="details-{{ fb.id }}" type="button">Подробнее ▾</button>

                  <form class="delete-form" action="{% url 'feedback_delete' fb.id %}" method="post" onsubmit="return confirm('Удалить отзыв #{{ fb.id }}?')">
                    {% csrf_token %}
                    <button type="submit" class="delete-btn">Удалить ✖</button>
                  </form>
                </div>
              </td>
            </tr>

            <tr class="details-row" aria-hidden="true">
              <td colspan="5" class="details-cell" id="details-{{ fb.id }}">
                <div class="details-inner" role="region" aria-labelledby="summary-{{ fb.id }}">
                  <div class="details-content">
                    <div class="left-col">
                      <div class="meta-row"><strong>Дата:</strong> {{ fb.created_at }}</div>

                      <div class="description" style="margin-top:8px">
                        {% if fb.description %}
                          {{ fb.description|linebreaksbr }}
                        {% else %}
                          <em class="muted">Описание отсутствует</em>
                        {% endif %}
                      </div>

                      {% if fb.admin_note %}
                        <div class="admin-note" style="margin-top:8px"><strong>Примечание админа:</strong><br>{{ fb.admin_note|linebreaksbr }}</div>
                      {% endif %}

                      {% if fb.attachments.all %}
                        <div style="margin-top:12px">
                          <strong>Файлы:</strong>
                          <div class="attachments" style="margin-top:6px">
                            {% for att in fb.attachments.all %}
                              <a href="{{ att.file.url }}" target="_blank" rel="noopener noreferrer">
                                {% if att.original_name %}{{ att.original_name }}{% else %}{{ att.file.name }}{% endif %}
                              </a>{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}
                    </div>

                    <div class="right-col">
                      {% if fb.images.all %}
                        <div class="images-section">
                          <div class="images-label" style="margin-bottom:6px;font-weight:600">Изображения</div>
                          <div class="images-grid">
                            {% for img in fb.images.all %}
                              <!-- thumb-btn хранит в data-full URL полноразмерного изображения -->
                              <button class="thumb-btn" type="button" data-full="{{ img.image.url }}" >
                                <img src="{{ img.image.url }}" alt="Изображение {{ forloop.counter }}" loading="lazy" />
                              </button>
                            {% endfor %}
                          </div>
                        </div>
                      {% else %}
                        <div class="muted">Изображений нет</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="5" style="padding:20px;text-align:center">Отзывов пока нет.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Модальное окно для просмотра изображения -->
    <div id="image-modal" class="image-modal" aria-hidden="true" role="dialog" aria-modal="true">
      <button class="modal-close" aria-label="Закрыть изображение" type="button">✖</button>
      <img class="modal-img" src="" alt="Полное изображение" />
      <div class="modal-caption" style="margin-top:8px;color:#fff"></div>
    </div>
  </div>

  <script>
  (function(){
    // элементарная защита: если скрипт подключен в head до DOM — дождёмся DOM
    function ready(fn){
      if (document.readyState !== 'loading') fn();
      else document.addEventListener('DOMContentLoaded', fn);
    }

    ready(function(){
      const expandAllBtn = document.getElementById('expand-all');
      const collapseAllBtn = document.getElementById('collapse-all');
      const detailsRows = () => Array.from(document.querySelectorAll('tr.details-row'));
      let lastFocusedThumb = null;

      // показать/скрыть детали: detailsRow — <tr>, toggleBtn — кнопка (может быть null)
      function openDetails(detailsRow, toggleBtn){
        detailsRow.setAttribute('aria-hidden','false');
        if (toggleBtn){
          toggleBtn.setAttribute('aria-expanded','true');
          toggleBtn.textContent = 'Свернуть ▴';
        }
      }
      function closeDetails(detailsRow, toggleBtn){
        detailsRow.setAttribute('aria-hidden','true');
        if (toggleBtn){
          toggleBtn.setAttribute('aria-expanded','false');
          toggleBtn.textContent = 'Подробнее ▾';
        }
      }

      // инициализация кнопок toggle
      document.querySelectorAll('.toggle-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          const summaryRow = btn.closest('.summary-row');
          if (!summaryRow) return;
          const detailsRow = summaryRow.nextElementSibling;
          if (!detailsRow || !detailsRow.classList.contains('details-row')) return;

          const isHidden = detailsRow.getAttribute('aria-hidden') === 'true' || detailsRow.getAttribute('aria-hidden') === null;
          if (isHidden) openDetails(detailsRow, btn);
          else closeDetails(detailsRow, btn);
          updateGlobalButtons();
        });
      });

      // expand / collapse all
      if (expandAllBtn) expandAllBtn.addEventListener('click', function(){
        detailsRows().forEach(function(r){
          const toggle = r.previousElementSibling?.querySelector('.toggle-btn') || null;
          openDetails(r, toggle);
        });
        updateGlobalButtons();
      });
      if (collapseAllBtn) collapseAllBtn.addEventListener('click', function(){
        detailsRows().forEach(function(r){
          const toggle = r.previousElementSibling?.querySelector('.toggle-btn') || null;
          closeDetails(r, toggle);
        });
        updateGlobalButtons();
      });

      function updateGlobalButtons(){
        const all = detailsRows();
        if (all.length === 0){
          if (expandAllBtn) expandAllBtn.style.display = 'none';
          if (collapseAllBtn) collapseAllBtn.style.display = 'none';
          return;
        }
        const opened = all.filter(r => r.getAttribute('aria-hidden') === 'false').length;
        if (opened === all.length){
          if (expandAllBtn) expandAllBtn.style.display = 'none';
          if (collapseAllBtn) collapseAllBtn.style.display = '';
        } else if (opened > 0){
          if (expandAllBtn) expandAllBtn.style.display = '';
          if (collapseAllBtn) collapseAllBtn.style.display = '';
        } else {
          if (expandAllBtn) expandAllBtn.style.display = '';
          if (collapseAllBtn) collapseAllBtn.style.display = 'none';
        }
      }

      // миниатюры -> модал
      document.querySelectorAll('.thumb-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          const src = btn.getAttribute('data-full') || btn.querySelector('img')?.src;
          if (!src) return;
          const modal = document.getElementById('image-modal');
          if (!modal) return;
          modal.querySelector('.modal-img').src = src;
          const caption = modal.querySelector('.modal-caption');
          caption.textContent = btn.getAttribute('aria-label') || '';
          modal.setAttribute('aria-hidden','false');
          lastFocusedThumb = btn;
          const closeBtn = modal.querySelector('.modal-close');
          if (closeBtn) closeBtn.focus();
        });
      });

      function closeModal(){
        const modal = document.getElementById('image-modal');
        if (!modal) return;
        modal.setAttribute('aria-hidden','true');
        const img = modal.querySelector('.modal-img');
        if (img) img.src = '';
        const cap = modal.querySelector('.modal-caption');
        if (cap) cap.textContent = '';
        if (lastFocusedThumb && typeof lastFocusedThumb.focus === 'function'){
          lastFocusedThumb.focus();
          lastFocusedThumb = null;
        }
      }

      // закрытие модалки по кнопке / клику вне / ESC
      const modalClose = document.querySelector('.modal-close');
      if (modalClose) modalClose.addEventListener('click', closeModal);
      const modalWrap = document.getElementById('image-modal');
      if (modalWrap) modalWrap.addEventListener('click', function(e){
        if (e.target === modalWrap) closeModal();
      });
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape' || e.key === 'Esc'){
          const modal = document.getElementById('image-modal');
          if (modal && modal.getAttribute('aria-hidden') === 'false'){
            closeModal();
            return;
          }
          // если модалки нет — закроем открытые детали
          const opened = detailsRows().filter(r => r.getAttribute('aria-hidden') === 'false');
          if (opened.length){
            opened.forEach(function(r){
              const toggle = r.previousElementSibling?.querySelector('.toggle-btn') || null;
              closeDetails(r, toggle);
            });
            updateGlobalButtons();
          }
        }
      });

      // при загрузке: скрываем все details и синхронизируем aria-expanded
      // (если в шаблоне есть строки с aria-hidden="false", то они останутся открыты)
      (function init(){
        document.querySelectorAll('tr.details-row').forEach(function(r){
          if (r.getAttribute('aria-hidden') !== 'false'){
            r.setAttribute('aria-hidden','true');
          } else {
            r.setAttribute('aria-hidden','false');
          }
          const toggle = r.previousElementSibling?.querySelector('.toggle-btn');
          if (toggle){
            const expanded = r.getAttribute('aria-hidden') === 'false';
            toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            toggle.textContent = expanded ? 'Свернуть ▴' : 'Подробнее ▾';
          }
        });
        updateGlobalButtons();
      })();

    }); // ready end
  })();
  </script>
</body>
</html>
